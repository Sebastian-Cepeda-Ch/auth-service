version: '3.8'

services:
  
  # --- Tu Servicio de Autenticación (Requisito 2.1) ---
  auth-service:
    build:
      context: ./auth-service # Directorio donde está el Dockerfile
      dockerfile: Dockerfile
    ports:
      # Exponemos el 8000 al host (ej: 8000:8000) solo para debug.
      # En producción, solo NGINX necesitaría acceder a él.
      - "8001:8000" # Mapeo el 8001 del host al 8000 del contenedor para no chocar con el 80
    environment:
      # Pasamos variables de entorno a la aplicación
      - DATABASE_URL=mongodb://mongo:27017/authdb
      - SECRET_KEY=ESTA_ES_UNA_CLAVE_MUY_SECRETA_PARA_PROD_CAMBIAME
    volumes:
      # Montar el código para desarrollo (hot-reloading si usas --reload)
      - ./auth-service:/app
    depends_on:
      - mongo # Asegura que la DB inicie primero
    networks:
      - microservices-net

  # --- Base de Datos MongoDB (Requisito 2.4) ---
  mongo:
    image: mongo:latest
    ports:
      # Exponer el puerto de Mongo al host (para conectar con MongoDB Compass, etc.)
      - "27017:27017"
    volumes:
      # Persistir los datos de la base de datos
      - mongo-data:/data/db
    networks:
      - microservices-net

  # --- Proxy Reverso NGINX (Requisito 2.5) ---
  nginx-proxy:
    image: nginx:latest
    ports:
      # El puerto principal de entrada a toda la aplicación
      - "80:80"
    volumes:
      # Montar nuestro archivo de configuración personalizado
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - auth-service # NGINX debe esperar a que el servicio de auth inicie
    networks:
      - microservices-net

# --- Volúmenes para persistencia de datos ---
volumes:
  mongo-data:
    driver: local

# --- Red interna para que los contenedores se comuniquen ---
networks:
  microservices-net:
    driver: bridge