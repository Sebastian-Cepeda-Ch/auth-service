# nginx/nginx.conf

events {
    # Configuración básica de eventos (obligatoria aunque esté vacía)
    worker_connections 1024;
}

http {
    server {
        listen 80;
        server_name localhost;

        # --- 1. RUTAS PARA EL AUTH SERVICE ---
        # Todo lo que venga con /api/auth/ se va al contenedor 'auth-service'
        location /api/auth/ {
            
            # REWRITE: Esto es importante.
            # El usuario pide: http://localhost/api/auth/users
            # NGINX lo cambia a: /users (le quita el prefijo)
            # Y se lo manda al contenedor.
            rewrite ^/api/auth/(.*)$ /$1 break;
            
            # PROXY PASS: Aquí decimos a qué contenedor llamar
            # 'auth-service' es el nombre que pusimos en docker-compose.yml
            proxy_pass http://auth-service:8000;
            
            # HEADERS: Pasamos información real del cliente
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- 2. RUTAS PARA EL GRAPHQL GATEWAY (NUEVO) ---
        # Todo lo que sea /graphql se va al contenedor 'graphql-gateway'
        location /graphql {
            
            # NOTA: Aquí NO usamos 'rewrite'. 
            # ¿Por qué? Porque en el código de Python del Gateway definimos:
            # prefix="/graphql". El contenedor ESPERA recibir "/graphql".
            
            proxy_pass http://graphql-gateway:8000;
            
            # Headers estándar
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Headers para WebSockets (GraphQL a veces usa esto para suscripciones)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}